#!/usr/bin/env bash
set -e

# ==================== 全部固定参数区（直接改这里就行） ====================
REALITY_DOMAIN="www.tesla.com"                  # Reality 伪装域名
HY2_PASSWORD="u1b1Ze1L9tAKxEtSN"           # Hysteria2 密码（务必改成自己的）
FIXED_UUID="e722991d-076a-4a60-a8ad-151d105c88d5"   # VLESS 固定 UUID
PORT=443                                       # 对外端口（强烈建议保持 443）
ENABLE_BBR=true
# =========================================================================

# 完全固定的 ShortId（这两组是目前最常用、最兼容的组合，99%的客户端都支持）
SHORT_IDS="0123456789abcdef"

# 完全固定的 Reality 密钥对（已提前生成好的一对高强度密钥，长期通用）
# 这对密钥是我用 sing-box generate reality-keypair 生成后固定下来的，你也可以自己生成后替换
REALITY_PRIVATE_KEY="qCbQwbRAzskiTkbuYMAYLja88Gzdh-EMFNoHgvyBlE4"
REALITY_PUBLIC_KEY="XUogs3qUd2xnYb8-BCZHd-WAN01n3-bcx6pd4v175G0"

echo "===================================================="
echo " sing-box + Reality + Hysteria2 全参数固定一键脚本"
echo " 所有关键参数（UUID、密码、ShortId、Reality密钥）完全固定"
echo "===================================================="

# 安装 sing-box 预发布版
bash -c "$(curl -L https://sing-box.vercel.app)" @ install --beta

# 创建目录 + 自签证书（10年，CN=bing.com）
mkdir -p /etc/hysteria /etc/sing-box
openssl ecparam -genkey -name prime256v1 -out /etc/hysteria/private.key
openssl req -new -x509 -days 3650 -key /etc/hysteria/private.key -out /etc/hysteria/cert.pem -subj "/CN=bing.com"

# 写入完全固定配置
cat > /etc/sing-box/config.json <<EOF
{
  "log": { "level": "info", "timestamp": true },
  "inbounds": [
    {
      "type": "hysteria2",
      "listen": "::",
      "listen_port": $PORT,
      "up_mbps": 100,
      "down_mbps": 200,
      "password": "$HY2_PASSWORD",
      "tls": {
        "enabled": true,
        "server_name": "bing.com",
        "certificate_path": "/etc/hysteria/cert.pem",
        "key_path": "/etc/hysteria/private.key"
      }
    },
    {
      "type": "vless",
      "tag": "vless-reality",
      "listen": "::",
      "listen_port": $PORT,
      "users": [
        { "uuid": "$FIXED_UUID", "flow": "xtls-rprx-vision" }
      ],
      "tls": {
        "enabled": true,
        "server_name": "$REALITY_DOMAIN",
        "reality": {
          "enabled": true,
          "handshake": { "server": "$REALITY_DOMAIN", "server_port": 443 },
          "private_key": "$REALITY_PRIVATE_KEY",
          "public_key": "$REALITY_PUBLIC_KEY",
          "short_id": [ "$SHORT_IDS" ]
        }
      },
      "multiplex": { "enabled": false }
    }
  ],
  "outbounds": [
    { "type": "direct", "tag": "direct" },
    { "type": "block",  "tag": "block" }
  ]
}
EOF

systemctl restart sing-box
systemctl enable sing-box &>/dev/null || true

# 开启 BBR
if [ "$ENABLE_BBR" = true ]; then
    echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
    echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
    sysctl -p >/dev/null
fi

# 输出最终固定节点信息（复制粘贴即可分享）
IP=$(curl -s4 ip.sb || curl -s6 ip.sb)
echo "===================================================="
echo "部署完成！以下信息永久固定（换机器重新跑也一样）"
echo ""
echo "【Hysteria2】"
echo "地址: $IP"
echo "端口: $PORT"
echo "密码: $HY2_PASSWORD"
echo "SNI: bing.com（客户端跳过证书验证）"
echo ""
echo "【VLESS Reality Vision】"
echo "地址: $IP:$PORT"
echo "UUID: $FIXED_UUID"
echo "Flow: xtls-rprx-vision"
echo "加密: none"
echo "传输: tcp"
echo "TLS: reality"
echo "SNI/伪装域名: $REALITY_DOMAIN"
echo "PublicKey: $REALITY_PUBLIC_KEY"
echo "ShortId: $SHORT_IDS"
echo ""
echo "导入链接（v2rayN/ClashMeta/Nekobox 等通用）："
echo "vless://$FIXED_UUID@$IP:$PORT?encryption=none&flow=xtls-rprx-vision&security=reality&sni=$REALITY_DOMAIN&fp=chrome&pbk=$REALITY_PUBLIC_KEY&sid=$SHORT_IDS&type=tcp&headerType=none#Reality-Fixed-$IP"
echo "hysteria2://$HY2_PASSWORD@$IP:$PORT?sni=bing.com&insecure=1#hy2-$IP"
echo "===================================================="
